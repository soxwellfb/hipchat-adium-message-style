<script language="Javascript" src="lib/jquery.min.js"></script>
<link rel="stylesheet" href="lib/highlight/styles/default.css">
<script src="lib/highlight/highlight.pack.js"></script>

<script type="text/javascript" defer="defer">

function scrubHTML(html) {
  // unescape HTML entities
  html = html.replace(/&amp;/ig, '&');
  html = html.replace(/&lt;/ig, '<');
  html = html.replace(/&gt;/ig, '>');
  //// undo Adium's terrible auto-linking
  // html = html.replace(/"<a href="https?:\/\/.+?" title="https?:\/\/.+?">(https?:\/\/.+?)<\/a>/g, '"$1"');
  // strip targets
  html = html.replace(/target="_blank"/g, '');
  return html
}

function unformatHTML(html) {
  // remove HTML formatting
  html = html.replace(/<br>/ig, '\n');
  html = html.replace(/&nbsp;/ig, ' ');
  return html
}

function hipChatizeHTML(html) {

  var messageNode = html.querySelector('#contents');
  var rawMessage = messageNode.innerHTML;
  var senderNode = html.querySelector('#sender');

  // scrub the raw message
  rawMessage = scrubHTML(rawMessage);

  // Look for /<keyword> commands, else do general message formatting  
  if(rawMessage.match(/^\s*\/code\s+/)) {
     // format /code
     rawMessage = rawMessage.replace(/^\s*\/code\s+(.*)/, '<pre><code>$1</pre></code>');
     messageNode.innerHTML = unformatHTML(rawMessage);
     hljs.highlightBlock(messageNode);
  } else if(rawMessage.match(/^\s*\/quote\s+/)) {
     // format /quote
     messageNode.innerHTML = rawMessage.replace(/^\s*\/quote\s+(.*)/, '<span class="monospace">$1</span>');
  } else if (rawMessage.match(/^page-default.*<b><a.*<\/a><\/b>.*page (created|updated) by/)) { // <a.*<\/a><\/b>\s+page\s+(created|updated)\s+by
     // confluence page creation
     // replace page-default with page icon
     // TODO: make icon blue, background grey - main.css needs major work
     messageNode.innerHTML = rawMessage.replace(/^page-default/, '<span class="icon">&#xF183;</span>');
  } else if (rawMessage.match(/^page-blogpost.*<b><a.*<\/a><\/b>.*blog post (created|updated) by/)) {
     messageNode.innerHTML = rawMessage.replace(/^page-blogpost/, '<span class="icon">&#xF182;</span>');
  } else {
     // add style to @ mentions - but not emails
     messageNode.innerHTML = rawMessage.replace(/(^|\s+)(@"*[\d\w]*)/g, '$1<span class="atTag">$2</span>');
  }
  


  // if we have a sender assume we are a 'real' first message
  if(senderNode != null) {

    var rawSender = senderNode.innerHTML;

    // truncate usernames, i.e. turn 'sc Seth Chisamore' into 'sc C.'
    senderParts = rawSender.split(' ');
    truncatedSender = senderParts[0];
    if(senderParts.length > 1) {
      truncatedSender = truncatedSender.concat(' ', senderParts.pop().slice(0,1), '.');
    }
    senderNode.innerText = truncatedSender;

    // Colorize the message
    if(/github|(chef\sclient)/gi.test(rawSender)) {
      messageClass = "systemMessage";
    } else if(/You have connected/gi.test(rawMessage)) {
      newContent = document.createTextNode('Welcome!');
      senderNode.appendChild(newContent);
      messageClass = "welcomeMessage";
    } else if(/jenkins/gi.test(rawSender)) {
      if(/failed/gi.test(rawMessage)) {
        messageClass = "systemMessage red";
      } else {
        messageClass = "systemMessage green";
      }
    } else {
      messageClass = "";
    }
    
    if(/jira/gi.test(rawSender)) {
      rawMessage = messageNode.innerHTML;
      messageNode.innerHTML = rawMessage.replace(/^<a.*>(.*)<\/a>(.*<a.*<a.*)<a.*>(.*)<\/a>(.*)<a.*>(.*)<\/a>(.*)$/, '<img src="$1">$2<img src="$3">$4<img src="$5">$6');
    } else if(/confluence/gi.test(rawSender)) {
      rawMessage = messageNode.innerHTML;
      messageClass = "systemMessage";
      if (rawMessage.match(/^approve/)) {
         // replace 'approve' with tick         
         // TODO: make tick and link green
         messageNode.innerHTML = rawMessage.replace(/^approve/, '<span class="icon">&#xF104;</span>');
         messageClass = "systemMessage green";
      }
    } 

    $(html.firstChild).addClass(messageClass);
  }

  return html;
}

</script>
